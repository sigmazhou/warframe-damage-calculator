AUTO-GENERATED BY AI

# Damage Calculation and Simulation

Technical overview of damage calculations and combat simulation mechanics.

---

## Overview

The damage calculator implements Warframe's damage system with accurate formulas for:
- Base damage multiplication from mods
- Critical hit mechanics (including orange/red crits)
- Multishot projectile calculation
- Element combination and ordering
- Status effects and damage-over-time (DOT)
- Faction bonuses and special enemy mechanics

---

## Damage Formula

### Single Hit Damage

```
SingleHit = BaseDamage × BaseMultiplier × CritMultiplier × ElementMultiplier × FactionBonus × FinalMultiplier
```

**Where:**
- **BaseDamage**: Weapon's base damage value
- **BaseMultiplier**: `1 + damage_from_mods`
- **CritMultiplier**: Average crit damage (see Critical Hits section)
- **ElementMultiplier**: Combined elemental damage (see Elements section)
- **FactionBonus**: `1 + faction_damage` (e.g., Bane mods)
- **FinalMultiplier**: Additional multipliers (buffs, debuffs)

### Direct DPS

```
DirectDPS = SingleHit × AttackSpeed × Multishot
```

**Where:**
- **AttackSpeed**: `base_attack_speed × (1 + attack_speed_mods)`
- **Multishot**: `base_multishot × (1 + multishot_mods)`

---

## Critical Hits

### Critical Chance

```
CritChance = base_crit_chance × (1 + crit_chance_mods)
```

Critical hits are tiered:
- **0-100%**: Yellow crits (0% to 100% chance)
- **100-200%**: Orange crits (guaranteed + chance for 2x)
- **200%+**: Red crits (guaranteed 2x + chance for 3x)

### Critical Damage Multiplier

```
CritDamage = base_crit_damage × (1 + crit_damage_mods) + additive_cd
```

**Note:** `additive_cd` includes bonuses like pet companion crit link (e.g., Adarza Kavat buff).

### Average Critical Multiplier

For analytical calculations (non-simulation):

```
AvgCritMultiplier = CritChance × (CritDamage - 1) + 1
```

For simulation, crits are rolled per shot:
- Roll determines tier: yellow (1x), orange (2x), or red (3x)
- Final multiplier: `tier × (CritDamage - 1) + 1`

---

## Element System

### Element Combination

Elements combine in order: **Mods → Weapon → In-Game Buffs**

**Basic Elements:** Heat, Cold, Electricity, Toxin

**Combined Elements:**
- Heat + Cold = **Blast**
- Heat + Toxin = **Gas**
- Heat + Electricity = **Radiation**
- Cold + Electricity = **Magnetic**
- Cold + Toxin = **Viral**
- Electricity + Toxin = **Corrosive**

**Example:**
```
Mods: [Heat, Cold]
Weapon: [Toxin]
Result: Blast (Heat+Cold), Toxin
```

### Element Damage Calculation

```
ElementMultiplier = 1 + Σ(element_values × vulnerability)
```

Each element's contribution:
```
element_value = base_element × (1 + element_mods)
```

**Vulnerabilities** apply per-enemy-type (e.g., Eidolons take extra damage from Radiation and Cold).

---

## Status Effects and DOT

### Status Chance

```
StatusChance = base_status_chance × (1 + status_chance_mods)
```

Status chance can exceed 100%, allowing multiple procs per shot.

### Status Proc Distribution

Each element's proc chance is weighted by its damage contribution:

```
element_proc_chance = StatusChance × (element_damage / total_damage)
```

### Damage Over Time (DOT)

Four primary DOT types:
- **Heat**: 50% base damage as fire DOT
- **Toxin**: 50% base damage bypassing shields
- **Slash**: 35% base damage as bleed (bypasses armor)
- **Electricity**: Chain damage to nearby enemies

**DOT Formula:**
```
DOT_DPS = 0.5 × BaseDamage × ElementMultiplier × ProcRate
```

**Where:**
- **ProcRate**: `StatusChance × AttackSpeed × Multishot × element_weight`

DOTs stack with each proc, creating layers that tick independently.

---

## Special Mechanics

### Galvanized Mods

Galvanized mods provide stacking bonuses:
- **Galvanized Shot**: +80% damage per stack (max 3 stacks)
- **Galvanized Aptitude**: +80% status chance per stack

Stacks are configured in `in_game_buffs`.

### Eidolon Shields

Eidolons (Tridolon type) have special mechanics:
- **Non-crit penalty**: Non-critical hits deal 50% damage to shields
- **Element bonuses**: 1.5× damage from Radiation and Cold

The damage calculator accounts for non-crit penalty:
```
EidolonMultiplier = 1 - (1 - CritChance) × 0.5
```

### Faction Damage

Faction mods (Bane mods) apply multiplicatively:
```
FactionBonus = 1 + faction_damage
```

Supports all factions: Grineer, Corpus, Infested, Corrupted.

---

## Combat Simulation

The calculator provides two modes:

### 1. Analytical Calculation (Default)

Uses average values for quick results:
- Average crit multiplier
- Average multishot
- Deterministic DOT calculation

**Use for:** Quick comparisons, build optimization

### 2. Monte Carlo Simulation

Simulates actual combat with RNG:
- Rolls critical hits per shot
- Rolls multishot per shot
- Rolls status procs based on chance and weights
- Tracks DOT instances over time

**Configuration:**
```json
{
  "duration": 10.0,
  "num_simulations": 10
}
```

**Simulation Process:**
1. For each shot:
   - Roll critical tier (yellow/orange/red)
   - Roll multishot (number of projectiles)
   - For each projectile:
     - Roll status procs based on element weights
     - Apply DOT instances
2. Tick DOT effects each frame (60 FPS)
3. Calculate total damage over duration
4. Repeat N times and return statistics

**Output:**
- Average DPS across simulations
- Standard deviation
- Min/max DPS values
- Total damage dealt

---

## Calculation Flow

```
1. Parse weapon stats, mods, rivens, and buffs
2. Combine all stat modifiers into InGameBuff
3. Combine elements in order (mods → weapon → buffs)
4. Calculate intermediate values:
   - Base multiplier
   - Critical multiplier
   - Multishot
   - Attack speed
   - Status chance
5. Calculate damage outputs:
   - Single hit damage
   - Direct DPS
   - DOT DPS for each element
6. (Optional) Run simulation for statistical analysis
7. Return damage breakdown and element distribution
```

---

## Implementation Notes

### Mod System

Mods are parsed from `mod_data.txt` with stat mappings:
- Standard stats: `damage`, `critical_chance`, `multishot`, etc.
- Elements: `heat_damage`, `cold_damage`, etc.
- Faction: `damage_vs_grineer`, etc.

### Riven Mods

Rivens use flat key format:
- Stats: `damage`, `critical_chance`
- Elements: `element_heat`, `element_cold`
- Faction: `faction_grineer`, `faction_corpus`

Up to 4 stats per riven, applied in reverse order for element combination.

### Data Structures

**WeaponStat**: Base weapon properties (damage, crit, status, elements)

**InGameBuff**: All accumulated modifiers from mods, rivens, and buffs

**Elements**: Dataclass tracking all 15 element types (physical, base, combined)

**EnemyStat**: Enemy faction, type, vulnerabilities, and DOT state

**DotState**: Tracks active DOT instances and their tick behavior

---

## Accuracy

The calculator implements Warframe mechanics with high accuracy:
- Tested against in-game Arsenal stats
- Validated with in-game damage numbers
- Accounts for rounding and truncation where applicable

**Known Limitations:**
- Armor scaling not fully implemented
- Some advanced status interactions simplified
- Combo counter mechanics pending

---

## Example Calculation

**Weapon:** 100 base damage, 25% crit chance, 2.0× crit damage
**Mods:** Serration (+165% damage), Split Chamber (+90% multishot)
**Fire Rate:** 10 shots/sec

**Calculation:**
```
BaseMultiplier = 1 + 1.65 = 2.65
CritMultiplier = 0.25 × (2.0 - 1) + 1 = 1.25
Multishot = 1 × (1 + 0.9) = 1.9

SingleHit = 100 × 2.65 × 1.25 × 1 = 331.25
DirectDPS = 331.25 × 10 × 1.9 = 6293.75
```

---

## Further Reading

- **API Documentation**: See `API_DOCS.md` for API reference
- **Mod Database**: `data/mod_data.txt` contains all mod stats
- **Source Code**: `src/calculator/damage_calculator.py` has full implementation
